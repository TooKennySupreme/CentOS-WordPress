
# Update system
# yum -y --exclude=kernel* --exclude=setup* update

# Tweak SSH settings for security
perl -pi -e 's/#UseDNS yes/UseDNS no/g' $ssh_conf
perl -pi -e 's/#PermitRootLogin yes/PermitRootLogin no/g' $ssh_conf
echo "AllowUsers $new_root_username" >> $ssh_conf

# Download and set up CentminMod directory
wget -P "$source_dir" "$centmin_dl_url$centmin_filename"
unzip "$source_dir$centmin_filename" -d "$source_dir"
rm "$source_dir$centmin_filename"

# Change time zone in centmin.sh
perl -pi -e 's/ZONEINFO=Australia/ZONEINFO=America/g' "$centmin_setup"
perl -pi -e 's/Brisbane/New_York/g' "$centmin_setup"

# Change custom TCP packet header in centmin.sh
perl -pi -e 's/nginx centminmod/MegabyteIO/g' "$centmin_setup"

# Run the Centmin Mod installation
chmod +x "$expect_dir"'centmin-install.exp'
chmod +x "$centmin_setup"
cd "$centmin_dir"
#"$expect_dir"'centmin-install.exp' "$root_password" 'memcached' "$memcached_password" "$centmin_setup"

# Change SSH port to new port designated in user-variables.sh
chmod +x "$expect_dir"'centmin-ssh.exp'
"$expect_dir"'centmin-ssh.exp' '22' "$new_ssh_port" "$centmin_setup"

# Copy nginx configuration files
for i in ""$confs_dir"nginx/*"
do
  cp -f $i $nginx_conf_dir
done

# Disable APC CLI in both the apc.ini file and the php.ini file
perl -pi -e 's/apc.enable_cli=1/apc.enable_cli=0/g' /root/centminmod/php.d/apc.ini
echo "apc.enable_cli = Off" >> /usr/local/lib/php.ini

# Changes shm_size to 256M - What's the optimal shm_size? Any ideas?
perl -pi -e 's/apc.shm_size=32M/apc.shm_size=256M/g' /root/centminmod/php.d/apc.ini

# Install WP-CLI
curl https://raw.github.com/wp-cli/wp-cli.github.com/master/installer.sh | bash
echo 'export PATH=/root/.wp-cli/bin:$PATH' >> ~/.bash_profile

# Install multisite
#chmod +x "$expect_dir"'centmin-website.exp'
#"$expect_dir"'centmin-website.exp' 

# Credits and further instructions
echo ""
echo ""
echo "$(tput bold)$(tput setaf 2)Installation Complete$(tput sgr0)"
echo ""
echo "$(tput bold)$(tput setaf 6)Thanks for choosing CentOS WordPress$(tput sgr0)"
echo "Home URL  : http://megabyte.io"
echo "Github URL: https://github.com/MByteIO/CentOS-WordPress"
echo "Author    : Brian Zalewski"
echo "Credit to CentminMod! Check out their website at http://centminmod.com/!"
echo ""
echo ""
echo "Set up DKIM e-mail authentication by going to admin.google.com -> Google Apps -> GMail -> Authenticate E-Mail."
echo ""
echo "$(tput bold)$(tput setaf 7)Read Me:$(tput sgr0) You should now restart the server. You can also test to make sure the web server works by going to your IP address in a browser. After you restart the server, you can automatically install, configure, and optimize a WordPress website by running:"
echo ""
echo ""
